#!/usr/bin/env node

var mysql = require('mysql');
var cli = require('commander');
var pkg = require('../package.json');
var executeLoadTest = require('../lib/execute');
var displayResults = require('../lib/results');

var count = 0;
var start = +new Date();
var time_between_requests = 1000;

cli.usage('[options]')
   .option('-h, --host <host>', 'location of the sphinx host', '127.0.0.1')
   .option('-p, --port <port>', 'sphinx host port number', 9306)
   .option('-q, --query <query', 'query to execute')
   .option('-n, --connections <connections>', 'number of connections to open', 1)
   .option('-c, --concurrency <concurrency>', 'how many concurrent queries per second', 1)
   .version(pkg.version);

    cli.parse(process.argv);

// Check we have some arguments, otherwise show the help menu
if (process.argv.length <= 2) {
    cli.help();
}

// Create a connection pool to Sphinx
var pool = mysql.createPool({
    host: cli.host,
    port: cli.port,
    connections: cli.connections,
});

// Execute the load test every X and display the results to the screen
setInterval(function() {
    executeLoadTest(pool, cli.query, count, cli.concurrency, function(updated_count) {
      // Update the count
      count = updated_count;

      // Display the results
      displayResults(start, count, cli);
    });
}, time_between_requests);

// Handle the test being halted and display the final results
process.on('SIGINT', function() {
    displayResults(start, count, cli);
    process.exit();
});
